<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebRTC Audio Call</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Inter', sans-serif;
    background: #f0f2f5;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px;
    color: #333;
  }

  h1 { margin-bottom: 20px; color: #4b6cb7; }

  .controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 20px;
  }

  input { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; outline: none; }

  button {
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    background: #4b6cb7;
    color: #fff;
    cursor: pointer;
    transition: 0.2s;
  }

  button:hover { background: #182848; }

  .status { margin-top: 15px; font-size: 14px; color: #555; }

  audio {
    margin-top: 20px;
    border-radius: 10px;
    background: #fff;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    width: 300px;
  }
</style>
</head>
<body>
<h1>WebRTC Audio Call</h1>

<div class="controls">
  <input id="myId" placeholder="Your ID">
  <input id="targetId" placeholder="Call To">
  <button id="connectBtn">Connect</button>
  <button id="callBtn" disabled>Call</button>
  <button id="acceptBtn" disabled>Accept</button>
  <button id="hangupBtn" disabled>Hang Up</button>
</div>

<div class="status" id="status">Not connected</div>

<audio id="localAudio" autoplay muted></audio>
<audio id="remoteAudio" autoplay></audio>

<script>
let localStream;
let peerConnection;
let ws;
let myId;
let incomingCall = null;

const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

const localAudio = document.getElementById("localAudio");
const remoteAudio = document.getElementById("remoteAudio");
const statusEl = document.getElementById("status");
const callBtn = document.getElementById("callBtn");
const acceptBtn = document.getElementById("acceptBtn");
const hangupBtn = document.getElementById("hangupBtn");

document.getElementById("connectBtn").onclick = async () => {
  myId = document.getElementById("myId").value.trim();
  if (!myId) return alert("Enter your ID");

  // ws = new WebSocket(`ws://${location.host}?userId=${myId}`);
  // Replace location.host with your LAN IP
  ws = new WebSocket(`ws://192.168.1.58:3000?userId=${myId}`);

  ws.onopen = () => {
    statusEl.textContent = "Connected to signaling server";
    callBtn.disabled = false;
  };

  ws.onmessage = async (event) => {
    const data = JSON.parse(event.data);
    if (data.type === "offer") {
      incomingCall = data;
      acceptBtn.disabled = false;
      statusEl.textContent = `Incoming call from ${data.from}`;
    } else if (data.type === "answer") {
      await peerConnection.setRemoteDescription({ type: "answer", sdp: data.sdp });
      statusEl.textContent = `Call connected`;
    } else if (data.type === "ice") {
      try { await peerConnection.addIceCandidate(data.candidate); } 
      catch(e){ console.error(e); }
    }
  };

  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  localAudio.srcObject = localStream;
};

callBtn.onclick = async () => {
  const targetId = document.getElementById("targetId").value.trim();
  if (!targetId) return alert("Enter target ID");

  startCall(targetId, true);
};

acceptBtn.onclick = async () => {
  if (!incomingCall) return;
  startCall(incomingCall.from, false, incomingCall.sdp);
  incomingCall = null;
  acceptBtn.disabled = true;
};

hangupBtn.onclick = () => {
  peerConnection.close();
  peerConnection = null;
  remoteAudio.srcObject = null;
  statusEl.textContent = "Call ended";
  hangupBtn.disabled = true;
};

function createPeerConnection(targetId) {
  peerConnection = new RTCPeerConnection(servers);

  peerConnection.ontrack = e => remoteAudio.srcObject = e.streams[0];

  peerConnection.onicecandidate = e => {
    if (e.candidate) ws.send(JSON.stringify({ type: "ice", to: targetId, candidate: e.candidate }));
  };
}

async function startCall(targetId, isCaller, offerSdp = null) {
  createPeerConnection(targetId);
  localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

  if (isCaller) {
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    ws.send(JSON.stringify({ type: "offer", to: targetId, sdp: offer.sdp, from: myId }));
    statusEl.textContent = `Calling ${targetId}...`;
  } else {
    await peerConnection.setRemoteDescription({ type: "offer", sdp: offerSdp });
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    // ws.send(JSON.stringify({ type: "answer", to: targetId, sdp: answer.sdp }));
    ws.send(JSON.stringify({ type: "answer", to: targetId, sdp: answer.sdp, from: myId }));

    statusEl.textContent = `Call connected with ${targetId}`;
  }

  hangupBtn.disabled = false;
}
</script>
</body>
</html>
